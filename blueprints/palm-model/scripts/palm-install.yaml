# Copyright 2022 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
- name: Install Palm Model
  hosts: localhost
  vars:
    install_prefix: ~/palm/current_version
    palm_version: v22.04-rc.1
    palm_dir: palm_model_system-{{ palm_version }}
    palm_model_url: https://gitlab.palm-model.org/releases/palm_model_system/-/archive/{{ palm_version }}/{{ palm_dir }}.tar.gz
  environment:
    install_prefix: "{{ install_prefix }}"
  tasks:
    - name: Make install directory
      file:
        path: "{{ install_prefix }}/{{ palm_dir }}"
        state: directory
        mode: "0755"
    - name: Get palm code
      get_url:
        url: "{{ palm_model_url }}"
        dest: "{{ install_prefix }}/{{ palm_dir }}"
        mode: "0664"
    - name: Extract palm model
      unarchive:
        src: "{{ install_prefix }}/{{ palm_dir }}/{{ palm_dir }}.tar.gz"
        dest: "{{ install_prefix }}"
    - name: Install local PALM configuration
      command: bash {{ palm_dir }}/install -p {{ install_prefix }}
      args:
        chdir: "{{ install_prefix }}"
    - name: Run basic test to validate installation
      command: "{{ install_prefix }}/bin/palmtest --cases urban_environment_restart --cores 4"
      args:
        chdir: "{{ install_prefix }}"
    - name: Create batch config based on default config
      copy:
        src: "{{ install_prefix }}/.palm.config.default"
        dest: "{{ install_prefix }}/.palm.config.batch"
        mode: "0664"
    - name: Update submit command in batch config
      lineinfile:
        path: "{{ install_prefix }}/.palm.config.batch"
        regexp: "^%submit_command"
        line: "%submit_command sbatch"
        state: present
    - name: Update default queue
      lineinfile:
        path: "{{ install_prefix }}/.palm.config.batch"
        regexp: "^%defaultqueue"
        line: "%defaultqueue compute"
        state: present
    - name: Update memory settings
      lineinfile:
        path: "{{ install_prefix }}/.palm.config.batch"
        regexp: "^%memory"
        line: "%memory 2300"
        state: present
    - name: Remove PBS directives
      lineinfile:
        path: "{{ install_prefix }}/.palm.config.batch"
        regexp: "^BDT?:#PBS"
        state: absent
    - name: Add Slurm directives
      blockinfile:
        path: "{{ install_prefix }}/.palm.config.batch"
        block: |
          BD:#!/bin/bash
          BD:#SBATCH --job-name=\{\{run_id\}\}
          BD:#SBATCH --time=\{\{cpu_hours\}\}:\{\{cpu_minutes\}\}:\{\{cpu_seconds\}\}
          BD:#SBATCH --ntasks=\{\{mpi_tasks\}\}
          BD:#SBATCH --nodes=\{\{nodes\}\}
          BD:#SBATCH --ntasks-per-node=\{\{tasks_per_node\}\}
          BD:#SBATCH --partition=\{\{queue\}\}
          BD:#SBATCH --output=\{\{job_protocol_file\}\}
          BD:#SBATCH --error=\{\{job_protocol_file\}\}
    - name: Install batch configuration
      command: "{{ install_prefix }}/bin/palmbuild -c batch -v"
      args:
        chdir: "{{ install_prefix }}"
